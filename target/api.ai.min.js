function _resamplerJs(){function e(a,b,c,f,d){this.fromSampleRate=a;this.toSampleRate=b;this.channels=c|0;this.outputBufferSize=f;this.noReturn=!!d;this.initialize()}e.prototype.initialize=function(){if(0>=this.fromSampleRate||0>=this.toSampleRate||0>=this.channels)throw Error("Invalid settings specified for the resampler.");this.fromSampleRate==this.toSampleRate?(this.resampler=this.bypassResampler,this.ratioWeight=1):(this.resampler=function(a){var b=Math.min(a.length,this.outputBufferSize);if(0!=
b%this.channels)throw Error("Buffer was of incorrect sample length.");if(0>=b)return this.noReturn?0:[];for(var c=0,f=Array(this.channels),d=0;d<this.channels;++d)f[d]=0;var g=0,h=0,e=!this.tailExists;this.tailExists=!1;var n=this.outputBuffer,l=0,k=0,m=this.ratioWeight;do{if(e)for(c=m,d=0;d<this.channels;++d)f[d]=0;else{c=this.lastWeight;for(d=0;d<this.channels;++d)f[d]=this.lastOutput[d];e=!0}for(;0<c&&g<b;)if(h=1+g-k,c>=h){for(d=0;d<this.channels;++d)f[d]+=a[g++]*h;k=g;c-=h}else{for(d=0;d<this.channels;++d)f[d]+=
a[g+(0<d?d:0)]*c;k+=c;c=0;break}if(0==c)for(d=0;d<this.channels;++d)n[l++]=f[d]/m;else{this.lastWeight=c;for(d=0;d<this.channels;++d)this.lastOutput[d]=f[d];this.tailExists=!0;break}}while(g<b);return this.bufferSlice(l)},this.ratioWeight=this.fromSampleRate/this.toSampleRate,this.tailExists=!1,this.lastWeight=0,this.initializeBuffers())};e.prototype.bypassResampler=function(a){return this.noReturn?(this.outputBuffer=a,a.length):a};e.prototype.bufferSlice=function(a){if(this.noReturn)return a;try{return this.outputBuffer.subarray(0,
a)}catch(b){try{return this.outputBuffer.length=a,this.outputBuffer}catch(c){return this.outputBuffer.slice(0,a)}}};e.prototype.initializeBuffers=function(){try{this.outputBuffer=new Float32Array(this.outputBufferSize),this.lastOutput=new Float32Array(this.channels)}catch(a){this.outputBuffer=[],this.lastOutput=[]}};navigator.Resampler=e}_resamplerJs();function _recorderWorkerJs(){function e(a){for(var d=b(f,c),d=g.resampler(d),e=new ArrayBuffer(2*d.length),e=new DataView(e),l=0,k=0;k<d.length;k++,l+=2){var m=Math.max(-1,Math.min(1,d[k]));e.setInt16(l,0>m?32768*m:32767*m,!0)}a=new Blob([e],{type:a});this.postMessage(a)}function a(){var a=[];a.push(b(f,c));this.postMessage(a)}function b(a,b){for(var d=new Float32Array(b),c=0,g=0;g<a.length;g++)d.set(a[g],c),c+=a[g].length;return d}var c=0,f=[],d,g;this.onmessage=function(b){switch(b.data.command){case "init":b=
b.data.config;(new Function(b.resamplerInitializerBody))();d=b.sampleRate;g=new navigator.Resampler(d,16E3,1,51200);break;case "record":b=b.data.buffer;f.push(b[0]);c+=b[0].length;break;case "export16kMono":e(b.data.type);break;case "getBuffer":a();break;case "clear":c=0,f=[]}}};(function(){function e(a){if("function"!==typeof a)throw Error("Illegal argument exception: argument is not a funtion: "+a);a=a.toString();var b=a.indexOf("{"),c=a.lastIndexOf("}");return 0<b&&0<c?a.substring(b+1,c):a}window.Recorder=function(a,b){var c=b||{},f=c.bufferLen||4096;this.context=a.context;this.node=this.context.createScriptProcessor(f,1,1);var d=new Worker((window.URL&&URL.createObjectURL.bind(URL)||window.webkitURL&&webkitURL.createObjectURL.bind(webkitURL)||window.createObjectURL)(new Blob([e(_recorderWorkerJs)],
{type:"text/javascript"})));d.postMessage({command:"init",config:{sampleRate:this.context.sampleRate,resamplerInitializerBody:e(_resamplerJs)}});var g=!1,h;this.node.onaudioprocess=function(a){g&&d.postMessage({command:"record",buffer:[a.inputBuffer.getChannelData(0)]})};this.configure=function(a){for(var b in a)a.hasOwnProperty(b)&&(c[b]=a[b])};this.record=function(){g=!0};this.stop=function(){g=!1};this.clear=function(){d.postMessage({command:"clear"})};this.getBuffer=function(a){h=a||c.callback;
d.postMessage({command:"getBuffer"})};this.export16kMono=function(a,b){h=a||c.callback;b=b||c.type||"audio/raw";if(!h)throw Error("Callback not set");d.postMessage({command:"export16kMono",type:b})};d.onmessage=function(a){h(a.data)};a.connect(this.node);this.node.connect(this.context.destination)}})();(function(){function e(a){this.chunkSize=a;this.array_data=[];this.callback=null}window.AudioContext=window.AudioContext||window.webkitAudioContext;AudioContext.prototype.createResampleProcessor=function(a,b,c,f){c=this.createScriptProcessor(a,b,c);var d=new navigator.Resampler(this.sampleRate,f,b,a,!0);c.onaudioprocess=function(a){var b=a.inputBuffer.getChannelData(0);a=a.outputBuffer.getChannelData(0);for(var b=d.resampler(b),c=0;c<b;++c)a[c]=d.outputBuffer[c]};return c};e.prototype.push=function(a){for(var b=
a.length,c=Array(Math.ceil(b/2)),f=0;f<b;f+=2)c[f/2]=a[f];Array.prototype.push.apply(this.array_data,c);this.process()};e.prototype.process=function(){for(var a;this.array_data.length>this.chunkSize;)a=this.array_data.splice(0,this.chunkSize),this.callback&&this.callback(a)};e.prototype.drop=function(){this.array_data.splice(0,this.array_data.length)};AudioContext.prototype.createEndOfSpeechProcessor=function(a){var b=this.createScriptProcessor(a,1,1);b.endOfSpeechCallback=null;var c=new VAD;b.vad=
c;var f=new e(160);f.callback=function(a){"CONTINUE"!==c.process(a)&&b.endOfSpeechCallback&&(b.endOfSpeechCallback(),f.drop())};b.onaudioprocess=function(a){var b=a.inputBuffer.getChannelData(0);a=a.outputBuffer.getChannelData(0);f.push(b);for(var c=0;c<b.length;c++)a[c]=b[c]};return b}})();(function(){function e(){this.reset()}e.prototype.process=function(a){a=this.frameActive(a);this.time=160*this.frameNumber/16E3;if(a)0<=this.lastActiveTime&&this.time-this.lastActiveTime<this.silenceLengthMilis?(this.sequenceCounter++,this.sequenceCounter>=this.minSequenceCount&&(this.lastSequenceTime=this.time,this.silenceLengthMilis=Math.max(this.minSilenceLengthMilis,this.silenceLengthMilis-(this.maxSilenceLengthMilis-this.minSilenceLengthMilis)/4))):this.sequenceCounter=1,this.lastSequenceTime=
this.time;else if(this.time-this.lastSequenceTime>this.silenceLengthMilis)return 0<this.lastSequenceTime?"TERMINATE":"NO_SPEECH";return"CONTINUE"};e.prototype.frameActive=function(a){for(var b=0,c=0,f=0,d=a.length,g=0;g<d;g++){var b=b+a[g]*a[g]/160,e=0,e=0<a[g]?1:-1;0!=f&&e!=f&&c++;f=e}this.frameNumber+=1;a=!1;this.frameNumber<this.noiseFrames?(this.noiseEnergy+=b/this.noiseFrames,console.log("noiseEnergy=",this.noiseEnergy)):c>=this.minCZ&&c<=this.maxCZ&&b>Math.max(.01,this.noiseEnergy)*this.energyFactor&&
(a=!0);return a};e.prototype.reset=function(){this.minCZ=5;this.maxCZ=15;this.frameLengthMilis=10;this.maxSilenceLengthMilis=3.5;this.minSilenceLengthMilis=.8;this.silenceLengthMilis=this.maxSilenceLengthMilis;this.sequenceLengthMilis=.03;this.minSequenceCount=3;this.energyFactor=3.1;this.noiseFrames=Math.round(150/this.frameLengthMilis);this.frameNumber=this.noiseEnergy=0;this.lastActiveTime=-1;this.time=this.sequenceCounter=this.lastSequenceTime=0};window.VAD=e})();(function(){function e(a,b,c,f){if(!a||!b)throw"Illegal TTS arguments: server and access_token are required.";this.access_token=b;this.server=a;this.lang=f;this.audio_context=c?c:new (window.AudioContext||window.webkitAudioContext)}e.prototype.tts=function(a,b,c){function f(a,b){var c=d.audio_context;c.decodeAudioData(a,function(a){console.log("play speech...");var d=c.createBufferSource();d.buffer=a;d.connect(c.destination);d.onended=b;d.start(0)},function(a){console.log("TTS decodeAudioData error is",
a)})}if(a){var d=this;a=encodeURIComponent(encodeURIComponent(a));var e=new ("onload"in new XMLHttpRequest?XMLHttpRequest:XDomainRequest);c=c||d.lang||"en-US";e.open("GET","https://"+d.server+"/api/tts?access_token="+d.access_token+"&lang="+c+"&text="+a,!0);e.responseType="arraybuffer";e.onload=function(a){f(this.response,b)};e.onerror=function(a){console.log("HttpRequest: Status:",this.status,"Reason:",a)};e.send()}};window.TTS=e})();(function(){function e(a){function b(){}a=a||{};this.server=a.server||"";this.token=a.token||"";this.sessionId=a.sessionId||"";this.lang=a.lang||"en";this.contentType=a.contentType||"content-type=audio/x-raw,+layout=(string)interleaved,+rate=(int)16000,+format=(string)S16LE,+channels=(int)1";this.readingInterval=a.readingInterval||250;this.onOpen=a.onOpen&&a.onOpen.bind(this)||b;this.onClose=a.onClose&&a.onClose.bind(this)||b;this.onInit=a.onInit&&a.onInit.bind(this)||b;this.onStartListening=a.onStartListening&&
a.onStartListening.bind(this)||b;this.onStopListening=a.onStopListening&&a.onStopListening.bind(this)||b;this.onResults=a.onResults&&a.onResults.bind(this)||b;this.onEvent=a.onEvent&&a.onEvent.bind(this)||b;this.onError=a.onError&&a.onError.bind(this)||b}e.prototype.init=function(){function a(a,c){b.mediaStreamSource=b.audio_context.createMediaStreamSource(c);b.onEvent(2,"Media stream created");window.userSpeechAnalyser=b.audio_context.createAnalyser();b.mediaStreamSource.connect(window.userSpeechAnalyser);
b.recorder=new Recorder(b.mediaStreamSource);b.onEvent(3,"Recorder initialized");a&&a()}var b=this;b.onEvent(1,"Waiting for approval to access your microphone ...");try{window.AudioContext=window.AudioContext||window.webkitAudioContext,navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia,window.URL=window.URL||window.webkitURL,b.audio_context=new AudioContext}catch(c){b.onError(5,"Error initializing Web Audio browser: "+JSON.stringify(c))}if(navigator.getUserMedia)navigator.getUserMedia({audio:!0},
a.bind(null,b.onInit),function(a){b.onError(5,"No live audio input in this browser: "+JSON.stringify(a))});else b.onError(5,"No user media support")};e.prototype.isInitialise=function(){return!!this.recorder};e.prototype.sendJson=function(a){this._socketSend(JSON.stringify(a));this._socketSend("EOS")};e.prototype.startListening=function(){function a(a){b.resample_processor=b.audio_context.createResampleProcessor(256,1,1,16E3);b.mediaStreamSource.connect(b.resample_processor);var c=b.audio_context.createEndOfSpeechProcessor(256);
c.endOfSpeechCallback=a;b.resample_processor.connect(c)}var b=this,c=b.recorder;if(c)if(b.ws)a(function(){b.stopListening()}),b.ws.send("{'timezone':'America/New_York', 'lang':'"+b.lang+"', 'sessionId':'"+b.sessionId+"'}"),b.intervalKey=setInterval(function(){c.export16kMono(function(a){b._socketSend(a);c.clear()},"audio/x-raw")},b.readingInterval),c.record(),b.onStartListening();else b.onError(3,"No web socket connection");else b.onError(3,"Recorder undefined")};e.prototype.stopListening=function(){var a=
this;a.resample_processor&&a.resample_processor.disconnect();clearInterval(a.intervalKey);var b=a.recorder;if(b)b.stop(),a.onEvent(11,"Stopped recording"),b.export16kMono(function(c){a._socketSend(c);a._socketSend("EOS");b.clear()},"audio/x-raw"),a.onStopListening();else a.onError(3,"Recorder undefined")};e.prototype.isOpen=function(){return!!this.ws};e.prototype.open=function(){function a(){function a(){var c=new WebSocket(b.server+"?"+b.contentType+"&access_token="+b.token);c.onmessage=function(a){a=
a.data;b.onEvent(8,a);if(a instanceof Object&&!(a instanceof Blob))b.onError(4,"WebSocket: onEvent: got Object that is not a Blob");else if(a instanceof Blob)b.onError(4,"WebSocket: got Blob");else b.onResults(JSON.parse(a))};c.onopen=function(a){b.onOpen();b.onEvent(9,a)};c.onclose=function(a){b.onClose();b.onEvent(10,a.code+"/"+a.reason+"/"+a.wasClean)};c.onerror=function(a){b.onError(2,JSON.stringify(a.data))};return c}if(b.recorder){b.ws&&b.close();try{b.ws=a()}catch(e){b.onError(5,"No web socket support in this browser!")}}else b.onError(3,
"Recorder undefined")}var b=this;this.recorder?a():this.init(a)};e.prototype.close=function(){clearInterval(this.intervalKey);this.recorder&&(this.recorder.stop(),this.recorder.clear(),this.onEvent(11,"Stopped recording"));this.ws&&(this.ws.close(),this.ws=null)};e.prototype._socketSend=function(a){if(this.ws){var b=this.ws.readyState;if(1!=b){var c="WebSocket: ";switch(b){case 0:c+="The connection is not yet open.";break;case 2:c+="The connection is in the process of closing.";break;case 3:c+="The connection is closed or couldn't be opened."}this.onError(2,
c+(" readyState="+b+" (!=1) failed to send: "+a))}if(a instanceof Blob)if(0<a.size)this.ws.send(a),this.onEvent(5,"Send: blob: "+a.type+", "+a.size);else this.onEvent(6,"Send: blob: "+a.type+", EMPTY");else this.ws.send(a),this.onEvent(7,"Send string: "+a)}else this.onError(5,"No web socket connection: failed to send: "+a)};window.ApiAi=e})();
